{{ define "pages/dashboard-new" }}
<!doctype html>
<html>

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    {{ template "template/head.includes" }}
    <title>Dashboard</title>
</head>

<body class="bg-gray-50">
    {{ template "template/components/error-notification" . }}
    {{ template "templates/navbar" }}

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Dashboard Header with Summary -->
        <div class="mb-8">
            <div class="md:flex md:items-center md:justify-between mb-6">
                <div class="flex-1 min-w-0">
                    <h1 class="text-2xl font-bold leading-7 text-gray-900 sm:text-3xl sm:truncate">
                        System Dashboard
                    </h1>
                    <p class="mt-1 text-sm text-gray-500">
                        Real-time overview of all applications and their health status
                    </p>
                </div>
                <div class="mt-4 flex md:mt-0 md:ml-4 space-x-4">
                    <!-- Last Refresh Indicator -->
                    <div class="flex items-center text-sm text-gray-500">
                        <svg class="mr-1 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <span id="last-refresh">Just now</span>
                    </div>
                    <!-- Refresh Button -->
                    <button 
                        hx-get="/dashboard/component" 
                        hx-target="#applications-container"
                        hx-swap="innerHTML"
                        hx-include="[name='healthy'],[name='unhealthy'],[name='maintenance'],[name='unknown'],[name='app_name'],[name='app_type']"
                        hx-on::after-request="updateLastRefresh()"
                        class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition-colors duration-200">
                        <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>

            <!-- Summary Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <!-- Total Applications -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-indigo-100 rounded-md p-3">
                                    <svg class="h-6 w-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Total Applications</dt>
                                    <dd class="text-lg font-medium text-gray-900">{{ .Dashboard.Summary.TotalApplications }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Healthy Applications -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-green-100 rounded-md p-3">
                                    <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Healthy Apps</dt>
                                    <dd class="text-lg font-medium text-gray-900">{{ .Dashboard.Summary.HealthyApplications }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Degraded/Unhealthy Applications -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-red-100 rounded-md p-3">
                                    <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Issues</dt>
                                    <dd class="text-lg font-medium text-gray-900">{{ add .Dashboard.Summary.DegradedApplications .Dashboard.Summary.UnhealthyApplications }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Total Instances -->
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <div class="bg-blue-100 rounded-md p-3">
                                    <svg class="h-6 w-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"></path>
                                    </svg>
                                </div>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Total Instances</dt>
                                    <dd class="text-lg font-medium text-gray-900">{{ .Dashboard.Summary.TotalInstances }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="bg-white shadow rounded-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-medium text-gray-900">Filters</h3>
                    <div class="flex items-center space-x-2 text-sm text-gray-500">
                        <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.207A1 1 0 013 6.5V4z"></path>
                        </svg>
                        <span id="filter-status">All applications</span>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Search by App Name -->
                    <div>
                        <label for="app-name-filter" class="block text-sm font-medium text-gray-700 mb-1">Application Name</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                </svg>
                            </div>
                            <input 
                                type="text" 
                                id="app-name-filter" 
                                name="app_name"
                                placeholder="Search applications..."
                                hx-get="/dashboard/component"
                                hx-target="#applications-container"
                                hx-swap="innerHTML"
                                hx-trigger="keyup changed delay:300ms"
                                hx-include="[name='healthy'],[name='unhealthy'],[name='maintenance'],[name='unknown'],[name='app_type']"
                                hx-on::after-request="updateLastRefresh()"
                                class="block w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md leading-5 bg-white placeholder-gray-500 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                        </div>
                    </div>

                    <!-- Application Type Filter -->
                    <div>
                        <label for="app-type-filter" class="block text-sm font-medium text-gray-700 mb-1">Application Type</label>
                        <div class="relative">
                            <select 
                                id="app-type-filter" 
                                name="app_type"
                                hx-get="/dashboard/component"
                                hx-target="#applications-container"
                                hx-swap="innerHTML"
                                hx-trigger="change"
                                hx-include="[name='healthy'],[name='unhealthy'],[name='maintenance'],[name='unknown'],[name='app_name']"
                                hx-on::after-request="updateLastRefresh()"
                                class="block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md bg-white">
                                <option value="">All Types</option>
                                <option value="JBoss">JBoss</option>
                                <option value="Springboot">Springboot</option>
                                <option value="Other">Other</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                <svg class="h-5 w-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <!-- Health Status Filters -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Show Status</label>
                        <div class="flex flex-wrap gap-4">
                            <label class="inline-flex items-center cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    name="healthy" 
                                    value="true" 
                                    checked
                                    hx-get="/dashboard/component"
                                    hx-target="#applications-container"
                                    hx-swap="innerHTML"
                                    hx-trigger="change"
                                    hx-include="[name='unhealthy'],[name='maintenance'],[name='unknown'],[name='app_name'],[name='app_type']"
                                    hx-on::after-request="updateLastRefresh()"
                                    class="rounded border-gray-300 text-green-600 shadow-sm focus:border-green-300 focus:ring focus:ring-green-200 focus:ring-opacity-50">
                                <span class="ml-2 text-sm text-gray-900">Healthy</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    name="unhealthy" 
                                    value="true" 
                                    checked
                                    hx-get="/dashboard/component"
                                    hx-target="#applications-container"
                                    hx-swap="innerHTML"
                                    hx-trigger="change"
                                    hx-include="[name='healthy'],[name='maintenance'],[name='unknown'],[name='app_name'],[name='app_type']"
                                    hx-on::after-request="updateLastRefresh()"
                                    class="rounded border-gray-300 text-red-600 shadow-sm focus:border-red-300 focus:ring focus:ring-red-200 focus:ring-opacity-50">
                                <span class="ml-2 text-sm text-gray-900">Issues</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    name="maintenance" 
                                    value="true" 
                                    checked
                                    hx-get="/dashboard/component"
                                    hx-target="#applications-container"
                                    hx-swap="innerHTML"
                                    hx-trigger="change"
                                    hx-include="[name='healthy'],[name='unhealthy'],[name='unknown'],[name='app_name'],[name='app_type']"
                                    hx-on::after-request="updateLastRefresh()"
                                    class="rounded border-gray-300 text-yellow-600 shadow-sm focus:border-yellow-300 focus:ring focus:ring-yellow-200 focus:ring-opacity-50">
                                <span class="ml-2 text-sm text-gray-900">Maintenance</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input 
                                    type="checkbox" 
                                    name="unknown" 
                                    value="true" 
                                    checked
                                    hx-get="/dashboard/component"
                                    hx-target="#applications-container"
                                    hx-swap="innerHTML"
                                    hx-trigger="change"
                                    hx-include="[name='healthy'],[name='unhealthy'],[name='maintenance'],[name='app_name'],[name='app_type']"
                                    hx-on::after-request="updateLastRefresh()"
                                    class="rounded border-gray-300 text-gray-600 shadow-sm focus:border-gray-300 focus:ring focus:ring-gray-200 focus:ring-opacity-50">
                                <span class="ml-2 text-sm text-gray-900">Unknown</span>
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Applications Container -->
        <div id="applications-container" class="min-h-32">
            {{ template "components/dashboard-applications" .Dashboard.Applications }}
        </div>

        <!-- Loading overlay (hidden by default) -->
        <div id="loading-overlay" class="hidden fixed inset-0 bg-gray-900 bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
                <svg class="animate-spin h-6 w-6 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="text-gray-700 font-medium">Refreshing dashboard...</span>
            </div>
        </div>
    </div>

    <!-- Auto-refresh and timestamp management -->
    <script>
        let lastRefreshTime = new Date();
        
        // Function to update the last refresh timestamp
        function updateLastRefresh() {
            lastRefreshTime = new Date();
            updateRefreshDisplay();
            updateFilterStatus();
        }
        
        // Function to update filter status display
        function updateFilterStatus() {
            const healthy = document.querySelector('[name="healthy"]').checked;
            const unhealthy = document.querySelector('[name="unhealthy"]').checked;
            const maintenance = document.querySelector('[name="maintenance"]').checked;
            const unknown = document.querySelector('[name="unknown"]').checked;
            const appName = document.querySelector('[name="app_name"]').value;
            const appType = document.querySelector('[name="app_type"]').value;
            
            let status = [];
            
            if (!healthy || !unhealthy || !maintenance || !unknown) {
                let statusTypes = [];
                if (healthy) statusTypes.push('healthy');
                if (unhealthy) statusTypes.push('issues');
                if (maintenance) statusTypes.push('maintenance');
                if (unknown) statusTypes.push('unknown');
                status.push(statusTypes.length > 0 ? statusTypes.join(', ') : 'none');
            }
            
            if (appName) {
                status.push(`name: "${appName}"`);
            }
            
            if (appType) {
                status.push(`type: ${appType}`);
            }
            
            const filterText = status.length > 0 ? `Filtered by ${status.join(', ')}` : 'All applications';
            document.getElementById('filter-status').textContent = filterText;
        }
        
        // Function to update the display of the refresh timestamp
        function updateRefreshDisplay() {
            const now = new Date();
            const diffMs = now - lastRefreshTime;
            const diffSeconds = Math.floor(diffMs / 1000);
            const diffMinutes = Math.floor(diffSeconds / 60);
            
            let displayText;
            if (diffSeconds < 5) {
                displayText = "Just now";
            } else if (diffSeconds < 60) {
                displayText = `${diffSeconds}s ago`;
            } else if (diffMinutes < 60) {
                displayText = `${diffMinutes}m ago`;
            } else {
                displayText = `${Math.floor(diffMinutes / 60)}h ago`;
            }
            
            document.getElementById('last-refresh').textContent = displayText;
        }
        
        // Update the display every second
        setInterval(updateRefreshDisplay, 1000);
        
        // Initialize the timestamp when page loads
        document.addEventListener('DOMContentLoaded', function() {
            updateLastRefresh();
        });
        
        // Auto-refresh every 30 seconds
        setInterval(function() {
            htmx.ajax('GET', '/dashboard/component', {
                target: '#applications-container',
                swap: 'innerHTML',
                values: {
                    healthy: document.querySelector('[name="healthy"]').checked,
                    unhealthy: document.querySelector('[name="unhealthy"]').checked,
                    maintenance: document.querySelector('[name="maintenance"]').checked,
                    unknown: document.querySelector('[name="unknown"]').checked,
                    app_name: document.querySelector('[name="app_name"]').value,
                    app_type: document.querySelector('[name="app_type"]').value
                }
            }).then(function() {
                updateLastRefresh();
            });
        }, 30000);

        // Add loading states to the refresh button
        document.addEventListener('htmx:beforeRequest', function(evt) {
            // Show loading for manual refresh button
            if (evt.detail.elt.querySelector('svg') && evt.detail.elt.tagName === 'BUTTON') {
                const button = evt.detail.elt;
                const svg = button.querySelector('svg');
                svg.classList.add('animate-spin');
                button.disabled = true;
                button.classList.add('opacity-75', 'cursor-not-allowed');
                
                // Add subtle loading indicator to applications container
                const container = document.getElementById('applications-container');
                container.classList.add('opacity-75', 'transition-opacity', 'duration-200');
            }
        });

        document.addEventListener('htmx:afterRequest', function(evt) {
            // Remove loading states
            if (evt.detail.elt.querySelector('svg') && evt.detail.elt.tagName === 'BUTTON') {
                const button = evt.detail.elt;
                const svg = button.querySelector('svg');
                svg.classList.remove('animate-spin');
                button.disabled = false;
                button.classList.remove('opacity-75', 'cursor-not-allowed');
                
                // Remove loading indicator from applications container
                const container = document.getElementById('applications-container');
                container.classList.remove('opacity-75');
            }
        });
    </script>

</body>

</html>
{{ end }}
